# üß† PsyTrade API Specification
**Version:** 1.2.1 (Frontend Gold Release)  
**Base URL:** `http://localhost:8000/api/v1`  
**Authentication:** Header `X-API-Key: dev_secret_key` (See `.env`)

---

## üèóÔ∏è 1. Integration Layer (Frontend "Glue")
The following endpoints are critical for the main dashboard and charting features.

### 1.1 üìà Market Data (Alpaca Proxy)
Use these endpoints to display real-time prices and charts. The backend securely proxies requests to Alpaca.

#### üîñ Get Real-Time Quote
**`GET /market/quote/{symbol}`**
Returns the latest Bid/Ask price for a ticker.

**Parameters:**
*   `symbol` (path, required): Ticker symbol (e.g., `AAPL`, `BTCUSD`).

**Response (200 OK):**
```json
{
  "symbol": "AAPL",
  "bid_price": 263.24,
  "ask_price": 263.30,
  "bid_size": 100,
  "ask_size": 100
}
```

#### üìä Get Historical Data (Charts)
**`GET /market/history/{symbol}`**
Returns OHLCV (Open, High, Low, Close, Volume) data for rendering candlestick charts.

**Parameters:**
*   `symbol` (path, required): Ticker symbol.
*   `timeframe` (query, optional): Candle size. Choices: `1m`, `5m`, `15m`, `1h`, `1d`. **Default:** `1d`.
*   `limit` (query, optional): Number of candles to return. **Default:** `100`.

**Response (200 OK):**
```json
{
  "symbol": "AAPL",
  "timeframe": "1d",
  "data": [
    {
      "timestamp": "2025-02-14T05:00:00+00:00",
      "open": 241.25,
      "high": 245.55,
      "low": 240.99,
      "close": 244.60,
      "volume": 40896227
    },
    // ... more candles
  ]
}
```

---

### 1.2 üí∞ Portfolio Performance
Use this endpoint to render the detailed "Equity Curve" or "Account Value Over Time" chart.

#### üìâ Get Portfolio History
**`GET /portfolio/history`**
Returns accurate historical daily snapshots of the user's account value.

**Parameters:**
*   `timeframe` (query, optional): The lookback period. Choices: `1W` (Week), `1M` (Month), `3M`, `1Y`. **Default:** `1M`.

**Response (200 OK):**
```json
{
  "timeframe": "1M",
  "interval": "1d",
  "data": [
    {
      "timestamp": "2026-02-01T12:00:00Z",
      "total_value": 10500.00,  // Total Equity (Cash + Positions)
      "cash": 500.00,           // Available Buying Power
      "positions_value": 10000.00,
      "day_pnl": 150.00,        // Daily Profit/Loss
      "pnl": 1250.00            // All-time PnL
    }
  ]
}
```

---

### 1.3 ‚ö° Real-Time Updates (The "Pulse")
**Pattern:** Poll this endpoint (`/updates/since`) every 5-10 seconds. This single call fetches ALL new Alerts, Trades, and Position changes, preventing the need to poll 3 separate endpoints.

#### üîÑ Poll for Updates
**`GET /updates/since`**

**Parameters:**
*   `timestamp` (query, required): Unix timestamp (float) of the *last successful update* you received.
    *   *First Call:* Use `Date.now() / 1000` or a timestamp from 24h ago.
    *   *Subsequent Calls:* Use the `latest_timestamp` returned from the previous response.

**Response (200 OK):**
Returns a list of polymorphic event objects.
```json
{
  "latest_timestamp": 1770426236.8456, // Store this for the next poll request!
  "updates": [
    {
      "type": "new_alert",
      "timestamp": 1770426230,
      "data": {
        "id": 10,
        "title": "Breakout detected",
        "message": "VIX is spiking...",
        "similarity_score": 0.92
      }
    },
    {
      "type": "trade_executed",
      "timestamp": 1770426235,
      "data": {
        "id": 55,
        "symbol": "NVDA",
        "side": "buy",
        "quantity": 10,
        "status": "filled"
      }
    },
    {
      "type": "position_update",
      "timestamp": 1770426235.5,
      "data": {
        "symbol": "NVDA",
        "quantity": 10,
        "pnl": 5.00
      }
    }
  ]
}
```

#### üì° Get Recent Signals
**`GET /signals/recent`**
Returns a list of active trading signals generated by the Autonomous Agents.

**Parameters:**
*   `limit` (query, optional): Max signals. **Default:** `50`.

**Response (200 OK):**
```json
{
  "signals": [
    {
      "id": 193,
      "symbol": "NAKED",
      "source": "reddit",
      "sentiment": -0.10,
      "reason": "Reddit: Short Strangles vs Reverse Jaded Lizard...",
      "timestamp": "2026-02-06T16:56:07.067443"
    }
  ]
}
```

---

### 1.4 üìö Analysis History (New)
**`GET /analysis/history/{ticker}`**
Returns historical analysis reports and decisions for a ticker.
*   **Response:**
    ```json
    {
      "ticker": "AAPL",
      "reports": [
        {
          "ticker": "AAPL",
          "trade_date": "2023-10-27",
          "final_decision": "BUY",
          "confidence": 0.85,
          "market_report": "Bullish trend confirmed...",
          "risk_debate": "Volatility is high...",
          "created_at": "2023-10-27T08:00:00"
        }
      ]
    }
    ```

### 1.5 üìä Positions Snapshot (New)
**`GET /positions`**
Returns current open positions directly from the broker (Alpaca) for immediate display.
*   **Params:** `status` (default: `open`)
*   **Response:**
    ```json
    {
      "positions": [
        {
          "symbol": "AAPL",
          "quantity": 10,
          "entry_price": 150.0,
          "current_price": 155.0,
          "unrealized_pnl": 50.0,
          "unrealized_pnl_percent": 3.33,
          "market_value": 1550.0,
          "side": "long"
        }
      ],
      "total_market_value": 1550.0,
      "total_unrealized_pnl": 50.0
    }
    ```

### 1.6 üìú Trade History (New)
**`GET /trades/history`**
Returns past trade executions from the database.
*   **Params:** `limit` (default: 100), `offset` (default: 0), `symbol` (optional)
*   **Response:**
    ```json
    {
      "trades": [
        {
          "id": "1",
          "symbol": "AAPL",
          "side": "buy",
          "quantity": 10,
          "price": 150.0,
          "status": "filled",
          "reason": "Autonomous Trade",
          "created_at": "2023-10-27T08:00:00"
        }
      ],
      "total_count": 1
    }
    ```

---

## üì∫ 2. The Monitor (Watchlist)

#### üìù Get Watchlist
**`GET /monitor/list`**
Returns the list of tickers currently being tracked for nightly analysis.

**Response:**
```json
[
  { "id": 1, "symbol": "AAPL", "is_active": true },
  { "id": 2, "symbol": "TSLA", "is_active": true }
]
```

#### ‚ûï Add Ticker
**`POST /monitor/add`**
Add a new ticker to the watchlist.
**Body:** `{ "symbol": "BTC" }`

#### ‚ûñ Remove Ticker
**`DELETE /monitor/remove`**
**Body:** `{ "symbol": "BTC" }`

---

## ü§ñ 3. Auto-Pilot (Control Panel)

### 3.1 üïπÔ∏è Get Status
**`GET /autonomous/status`**
Returns the engine's heartbeat. Use this for the "System Status" widget.
*   **Response:**
    ```json
    {
      "enabled": true,
      "signals_count": 12,
      "open_positions": 2,
      "account_value": 1050.25,
      "cash": 800.00
    }
    ```

### 3.2 ‚öôÔ∏è Get Configuration
**`GET /autonomous/config`**
Returns current budget and risk settings.
*   **Response:**
    ```json
    {
      "is_autonomous_active": true,
      "total_budget": 5000.0,
      "current_allocation": 3200.0,
      "max_position_size": 1000.0,
      "max_drawdown": 500.0,
      "risk_tolerance": "medium",
      "allowed_symbols": ["AAPL", "NVDA"],
      "min_confidence_threshold": 0.70
    }
    ```

#### ‚öôÔ∏è Update Configuration
**`POST /autonomous/config`**
Use this to start/stop the bot or change its budget.
**Body:**
```json
{
  "is_autonomous_active": true,
  "total_budget": 5000.0
}
```

---

## üëÅÔ∏è 4. User Interaction (Observer)

#### üñ±Ô∏è Log User Action
**`POST /observer/log`**
**Crucial:** Call this whenever the user views a chart or clicks a ticker. This builds the "Trader DNA".
**Body:**
```json
{
  "activity_type": "chart_view",
  "symbol": "TSLA",
  "client_context": "User checked 1H chart for 5 mins"
}
```

#### üõí Execute Manual Trade
**`POST /trades/execute`**
Places a trade immediately.
**Body:**
```json
  "reason": "I like this stock"
}
```

---

## üõ°Ô∏è 5. The Sentinel (Alerts)

### 5.1 üîî Get Alerts
**`GET /sentinel/alerts`**
Returns generated alerts ("News-to-History" matches).
*   **Params:** `limit` (default 50), `is_read` (bool), `alert_type` (string)
*   **Response:**
    ```json
    [
      {
        "id": 10,
        "title": "Danger: High VIX",
        "message": "VIX is up 5%...",
        "alert_type": "risk_warning",
        "similarity_score": 0.92,
        "is_read": false,
        "timestamp": "2026-02-07T09:15:00Z",
        "ticker": null
      },
      {
        "id": 14,
        "title": "Strong Buy Signal",
        "message": "AAPL showing bullish divergence...",
        "alert_type": "opportunity",
        "similarity_score": 0.85,
        "is_read": true,
        "timestamp": "2026-02-06T14:30:00Z",
        "ticker": "AAPL"
      }
    ]
    ```
